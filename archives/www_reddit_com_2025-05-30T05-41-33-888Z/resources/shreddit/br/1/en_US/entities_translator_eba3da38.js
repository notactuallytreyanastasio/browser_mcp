import{_ as t,g as a,aQ as s,bn as n,bo as i,bp as e}from"./shell-2264602c.js";import{x as r}from"./icon-82dd10b4.js";import{B as o}from"./base-translator-57da136d.js";class l extends o{constructor(){super(...arguments),this._partialRequestController=new s(this),this.isFetchingTranslations=!1,this.translationCache=new Map}async onTranslationsEnabled(){await this.runTranslations()}async onTranslationsDisabled(){await this.runTranslations()}async runTranslations(){this.isFetchingTranslations||(await this.fetchUntranslatedEntities(),this.renderTranslationCache())}async fetchUntranslatedEntities(){if(this.isFetchingTranslations)return!1;const t=this.getTranslatableEntities();this.updateCacheWithEntities(t);const a=[];if(this.translationCache.forEach((t=>{(this.translationContextValue.isTranslationActive?!!t.translatedValue:!!t.originalValue)||a.push(t)})),!a.length)return!1;const s=await this.fetchTranslatableEntities(a);return this.updateCacheWithEntities(s),s}updateCacheWithEntities(t){t.forEach((t=>{const a=this.translationCache.get(t.id);if(!a)return void this.translationCache.set(t.id,t);let s=!1;const n={};t.translatedValue&&!a.translatedValue&&(n.translatedValue=t.translatedValue,s=!0),t.originalValue&&!a.originalValue&&(n.originalValue=t.originalValue,s=!0),s&&this.translationCache.set(t.id,{...a,...n})}))}async fetchArbitraryStrings(t){const a=new FormData;t.forEach((({originalValue:t})=>a.append("strings[]",t)));const s=await this.requestPartial("/svc/shreddit/translated-strings",{method:n.Post,body:a});if(!s)return t;return t.map(((t,a)=>{const n=document.createElement("div");n.innerHTML=s[a]?.innerHTML||"";return{...t,translatedValue:n.innerHTML||""}}))}async requestPartial(t,a){this.isFetchingTranslations=!0;const s=await this._partialRequestController.request(t,a),n=s?.text?await(s?.text()):"";this.isFetchingTranslations=!1;const r=n&&!1===n.includes?.(i);return r||this.logError({error:"entities-translator: request partial error",metadata:{url:t,options:a}}),!!r&&Array.from(e(n))}renderTranslationCache(t){const a=t??this.translationContextValue.isTranslationActive;this.translationCache.forEach((t=>{if("boolean"==typeof t.isTranslated&&t.isTranslated===a)return;const{render:s,node:n,originalValue:i,translatedValue:e}=t,r=a?e:i;r&&s(n,r,a),t.isTranslated=a}))}render(){return r`<div> <slot></slot> </div>`}}t([a()],l.prototype,"translationCache",void 0);export{l as E};
