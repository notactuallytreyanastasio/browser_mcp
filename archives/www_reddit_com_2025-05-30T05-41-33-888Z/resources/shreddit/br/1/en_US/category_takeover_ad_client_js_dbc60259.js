import{H as e,b as t,dJ as i,E as s,c as r,hK as o,gg as a,at as n,_ as l,g as d,n as h,e as c,P as p,t as m,T as u,av as y,au as g}from"./shell-2264602c.js";import{s as v,A as b,x as I}from"./icon-82dd10b4.js";import{O as E,W as C,e as k}from"./with-ad-observer-3dfd9c4c.js";import{s as f,a as w}from"./activate-lead-gen-dialog-d08e1e7d.js";import"./click-location-tracker-1589a523.js";import"./shreddit-dynamic-ad-link-548337a6.js";import{bI as D,o as S}from"./age-gate-standalone-client-js-5357b0cf.js";import{C as P}from"./community-club-highlights-client-js-a6b43ba7.js";import{G as L}from"./gallery-4693e59b.js";import{P as A,a as O,E as M}from"./overflow-menu-actions-97fa1cfc.js";import{I as V,J as x}from"./links-9b598b77.js";import"./errors-8d0111b7.js";import"./TinyGesture-89d9957c.js";import"./subreddit-posting-eligibility-8f99a053.js";import"./distinguished-tags-ad178980.js";function B({galleryIdx:i,galleryData:s,impressionId:r,postId:o}){const a=s[i];if(!a)return null;const n={action_info:{page_type:e.PostDetail},post:{id:o,promoted:!0},media:{id:a.media.id,height:a.media.height,width:a.media.width,url:a.outboundUrl},gallery:{id:a.id,position:i,media_ids:s.map((e=>e.media.id)),num_items:s.length},ad_metadata:{impression_id:r}};return t({source:"gallery",action:"view",noun:"media"},n)}const T="visibleClassnames",j="hiddenClassnames";class G{constructor(e){this.areItemsLoaded=!1,(this.host=e).addController(this),this.eventController=new s(e)}get galleryItemEls(){return Array.from(this.host.querySelectorAll(".product-carousel-item"))}async waitUntilImagesLoaded(){return new Promise((e=>{this.areItemsLoaded&&e();let t=0;const i=()=>{t++,t===this.galleryItemEls.length&&(this.areItemsLoaded=!0,e())};this.galleryItemEls.forEach((e=>{const t=e.querySelector("img");t.complete?i():t.onload=()=>{i()}}))}))}handleCarouselArrowClick(e){const s=e.detail.direction===P.FORWARDS?L.Forward:L.Backward,r=function({direction:e,numGalleryItems:s,placement:r,impressionId:o,postId:a,authorId:n,subredditId:l,title:d}){return t({source:"gallery",action:"click",noun:e},{gallery:{num_items:s,position:void 0},ad_metadata:{placement:r,impression_id:o},post:{id:a,author_id:n,promoted:!0,subreddit_id:l,title:d,type:i.Gallery}})}({authorId:this.host.authorId,impressionId:this.host.impressionId,numGalleryItems:this.host.galleryItems?.length??0,placement:this.host.placement,postId:this.host.id,subredditId:this.host.subredditId,title:this.host.title,direction:s});this.host.trackEvent(r)}getActiveSlideIndex(e){const t="SHREDDIT-DYNAMIC-AD-LINK"===e.nodeName?e:e.querySelector("shreddit-dynamic-ad-link"),i=t?.galleryIndex;return void 0===i?null:i}async observeGalleryItems(e){try{await this.waitUntilImagesLoaded()}catch(e){return}this.galleryItemEls.forEach((t=>e.observe(t)))}async setupGalleryViewMediaTracking(){const e=this.createGalleryViewMediaObserver();this.galleryViewMediaObserver=e,await this.observeGalleryItems(this.galleryViewMediaObserver)}async setupPixelImpressionTracking(){const e=this.createImpressionObserver();this.galleryImpressionObserver=e,await this.observeGalleryItems(this.galleryImpressionObserver)}teardownObserver(e){e&&this.galleryItemEls.forEach((t=>e.unobserve(t)))}createImpressionObserver(){return new IntersectionObserver((e=>{e.forEach((e=>{if(!e.isIntersecting)return;const t=this.getActiveSlideIndex(e.target);if(null===t)return;const i=r(E,{itemIndex:t,postId:this.host.id});this.host.dispatchEvent(i),this.galleryImpressionObserver?.unobserve(e.target)}))}),{threshold:.25})}createGalleryViewMediaObserver(){return new IntersectionObserver((e=>{e.forEach((e=>{if(!e.isIntersecting)return;const t=this.getActiveSlideIndex(e.target);if(null===t)return;const i=r("track-event",{details:B({galleryData:this.host.galleryItems||[],galleryIdx:t,impressionId:this.host.impressionId,postId:this.host.id})});this.host.dispatchEvent(i),this.galleryViewMediaObserver?.unobserve(e.target)}))}),{threshold:.2})}async hostConnected(){this.host.galleryItems&&(this.eventController.define("faceplate-carousel:slide",this.handleCarouselArrowClick.bind(this)),await this.setupPixelImpressionTracking(),await this.setupGalleryViewMediaTracking())}hostDisconnected(){this.teardownObserver(this.galleryImpressionObserver),this.teardownObserver(this.galleryViewMediaObserver)}}class _{constructor(e){this.isDown=!1,this.startX=0,this.scrollLeft=0,this.onMouseDown=e=>{this.galleryImagesContainer&&(this.isDown=!0,this.startX=e.pageX-this.galleryImagesContainer.offsetLeft,this.scrollLeft=this.galleryImagesContainer.scrollLeft)},this.unsetIsDown=()=>{this.isDown=!1},this.onMouseMove=e=>{if(!this.galleryImagesContainer)return;if(!this.isDown)return;e.preventDefault();const t=3*(e.pageX-this.galleryImagesContainer.offsetLeft-this.startX);this.galleryImagesContainer.scrollLeft=this.scrollLeft-t},(this.host=e).addController(this)}get hasHorizontalDragBehavior(){return this.host.useLegacyDragNav}get galleryImagesContainer(){return document.querySelector(".gallery-images-container")}setupDesktopDragScroll(){this.galleryImagesContainer?.addEventListener("mousedown",this.onMouseDown),this.galleryImagesContainer?.addEventListener("mouseleave",this.unsetIsDown),this.galleryImagesContainer?.addEventListener("mouseup",this.unsetIsDown),this.galleryImagesContainer?.addEventListener("mousemove",this.onMouseMove)}teardownDesktopDragScroll(){this.galleryImagesContainer?.removeEventListener("mousedown",this.onMouseDown),this.galleryImagesContainer?.removeEventListener("mouseleave",this.unsetIsDown),this.galleryImagesContainer?.removeEventListener("mouseup",this.unsetIsDown),this.galleryImagesContainer?.removeEventListener("mousemove",this.onMouseMove)}hostConnected(){this.host.useLegacyDragNav&&this.galleryImagesContainer&&this.setupDesktopDragScroll()}hostDisconnected(){this.host.useLegacyDragNav&&this.galleryImagesContainer&&this.teardownDesktopDragScroll()}}class U{constructor(e){(this.host=e).addController(this),this.expandVideoPlayer=this.expandVideoPlayer.bind(this),this.hideVideoPlayer=this.hideVideoPlayer.bind(this)}get videoPlayerEl(){return this.host.querySelector(".comments-page-ad-expandable-video-player")}get videoPlayerCloseBtnEl(){return this.host.querySelector(".comments-page-ad-video-player-close-btn")}get thumbnailContainerEl(){return this.host.querySelector(".comments-page-ad-thumbnail-container")}get thumbnailImageEl(){return this.host.querySelector(".comments-page-ad-thumbnail-img")}get thumbnailPlayBtnEl(){return this.host.querySelector(".thumbnail-playback-action-circle")}get shredditPlayer(){return this.host.querySelector("shreddit-player-2")}toggleElVisibility(e,t){if(null===e)return;const i=t?e.dataset[j]:e.dataset[T];i&&i?.split(" ").forEach((t=>{e.classList.remove(t)}));const s=t?e.dataset[T]:e.dataset[j];s&&s?.split(" ").forEach((t=>{e.classList.add(t)}))}expandVideoPlayer(){this.toggleElVisibility(this.videoPlayerEl,!0),this.toggleElVisibility(this.thumbnailContainerEl,!1),this.toggleElVisibility(this.thumbnailImageEl,!1),this.toggleElVisibility(this.thumbnailPlayBtnEl,!1),setTimeout((()=>{this.shredditPlayer&&this.host.setVideoAdMeasurerDimensions(this.shredditPlayer.offsetHeight,this.shredditPlayer.offsetWidth)}),300)}hideVideoPlayer(){this.toggleElVisibility(this.videoPlayerEl,!1),this.toggleElVisibility(this.thumbnailContainerEl,!0),this.toggleElVisibility(this.thumbnailImageEl,!0),this.toggleElVisibility(this.thumbnailPlayBtnEl,!0),this.shredditPlayer?.mediaUI?.hasAttribute(o.PLAYING)&&this.host.dispatchEvent(new CustomEvent(a,{detail:{currentTime:this.shredditPlayer?.videoElement.currentTime,duration:this.shredditPlayer?.videoElement.duration}}))}async hostConnected(){this.host.adType===n.VIDEO&&(this.thumbnailContainerEl?.addEventListener("click",this.expandVideoPlayer),this.videoPlayerCloseBtnEl?.addEventListener("click",this.hideVideoPlayer))}hostDisconnected(){this.host.adType===n.VIDEO&&(this.thumbnailContainerEl?.removeEventListener("click",this.expandVideoPlayer),this.videoPlayerCloseBtnEl?.removeEventListener("click",this.hideVideoPlayer))}}const H=C(v);let R=class extends H{constructor(){super(...arguments),this.outboundLinkUrl="",this.isBlank=!1,this.impressionId="0",this.isShoppingAd=!1,this.isHideAdEnabled=!1,this.hidden=!1,this.isMobile=!1,this.useLegacyDragNav=!1,this.shouldTrackPosition=!1,this.isPdpCombined=!1,this.isCategoryTakeover=!1,this.isPixelFiringRefactorExperimentEnabled=!1,this.isHiddenOnSort=!1,this.isClickDisabled=!1,this._events=new s(this),this.videoInteractionController=new U(this),this.galleryTrackingController=new G(this),this.dragScroll=new _(this),this.pubsub=new p(this),this.handleRsvpClick=e=>{this.trackEvent(V(this))},this.handleUnRsvpClick=e=>{this.trackEvent(x(this))},this.onAdUpdateAction=({action:e,value:t,impressionId:i})=>{this.impressionId===i&&e===A.hide&&(this.hidden=t)},this.handleHideOnSort=()=>{this.isHiddenOnSort=!0},this.handleBlockPdpAdClick=({delay:e})=>{this.isClickDisabled=!0,setTimeout((()=>{this.isClickDisabled=!1}),e)},this._trackAdClick=this._events.define("observe-ad-click",(async e=>{await this._activateLeadGenDialog(),f({leadGenInfo:this.leadGenInfo,postId:this.id,impressionId:this.impressionId,onSuccess:()=>this.dispatchEvent(r(D))})}))}static get styles(){return[m]}getAdObserverConfig(){return{events:k(this.adEvents),postId:this.id,impressionId:this.impressionId,postElement:this,galleryItems:this.galleryItems?.map((e=>({...e,adEvents:k(e.adEvents)}))),adType:this.adType}}async connectedCallback(){super.connectedCallback(),this.enableAdObserver(this.getAdObserverConfig()),this.pubsub.subscribe(u.AdUpdated,this.onAdUpdateAction),this.pubsub.subscribe(u.CommentSort,this.handleHideOnSort),this.pubsub.subscribe(u.BlockPdpAdClick,this.handleBlockPdpAdClick),this.addEventListener(O,this.handleRsvpClick),this.addEventListener(M,this.handleUnRsvpClick),await this.resolveCarouselDependencies()}async disconnectedCallback(){super.disconnectedCallback(),this.adMeasurer&&this.adMeasurer.handleUnload(),this.pubsub.unsubscribe(u.AdUpdated,this.onAdUpdateAction),this.pubsub.unsubscribe(u.CommentSort,this.handleHideOnSort),this.pubsub.unsubscribe(u.BlockPdpAdClick,this.handleBlockPdpAdClick),this.removeEventListener(O,this.handleRsvpClick),this.removeEventListener(M,this.handleUnRsvpClick)}setVideoAdMeasurerDimensions(e,t){this.adMeasurer&&(this.adMeasurer.dimensions={height:e,width:t})}_activateLeadGenDialog(){return w({leadGenInfo:this.leadGenInfo})}get shouldRenderCarouselComponent(){return Array.isArray(this.galleryItems)&&!this.isMobile&&!this.useLegacyDragNav}async resolveCarouselDependencies(){this.shouldRenderCarouselComponent&&(await import("./shreddit-gallery-carousel-fa062bb2.js"),this.querySelector("shreddit-gallery-carousel")?.classList.remove("flex"))}render(){return this.hidden&&this.isHideAdEnabled||this.isHiddenOnSort?b:I` <shreddit-with-observer-wrapper id="${"comments-page-ad"}" .config="${{threshold:y}}"> <div class="${S(this.isMobile&&this.placement!==g.COMMENT_TREES&&"mx-md",this.isClickDisabled&&"pointer-events-none")}"> <slot name="full-comments-page-ad-link"></slot> ${this.isCategoryTakeover?I` <slot name="ad-format-content"></slot> <slot name="expanded-video-player"></slot> <slot name="disclaimer-text"></slot> `:I` <slot name="credit-bar"></slot> <slot name="ad-format-content"></slot> <slot name="call-to-action-row"></slot> <slot name="ad-reminder-bar"></slot> <slot name="expanded-video-player"></slot> `} </div> </shreddit-with-observer-wrapper> `}};l([h({type:String,attribute:"post-id"})],R.prototype,"postId",void 0),l([h({type:Array,attribute:"ad-events",reflect:!0})],R.prototype,"adEvents",void 0),l([h({type:Array,attribute:"gallery-items"})],R.prototype,"galleryItems",void 0),l([h({type:String,attribute:"outbound-link-url"})],R.prototype,"outboundLinkUrl",void 0),l([h({type:Boolean,attribute:"is-blank"})],R.prototype,"isBlank",void 0),l([h({type:Object,attribute:"lead-gen-info"})],R.prototype,"leadGenInfo",void 0),l([h({type:String,attribute:"impression-id"})],R.prototype,"impressionId",void 0),l([h({type:String,attribute:"ad-type"})],R.prototype,"adType",void 0),l([h({type:String,attribute:"campaign-id"})],R.prototype,"campaignId",void 0),l([h({type:Object,attribute:"ad-user-targeting-info"})],R.prototype,"adUserTargeting",void 0),l([h({type:Boolean,attribute:"is-shopping-ad"})],R.prototype,"isShoppingAd",void 0),l([h({type:Boolean,attribute:"is-hide-ad-enabled"})],R.prototype,"isHideAdEnabled",void 0),l([h({type:Boolean,reflect:!0})],R.prototype,"hidden",void 0),l([h({type:Boolean,attribute:"is-mobile"})],R.prototype,"isMobile",void 0),l([h({type:Boolean,attribute:"use-legacy-drag-nav"})],R.prototype,"useLegacyDragNav",void 0),l([h({type:String,attribute:"subreddit-id"})],R.prototype,"subredditId",void 0),l([h({type:String,attribute:"country-code"})],R.prototype,"countryCode",void 0),l([h({type:String,attribute:"author-id"})],R.prototype,"authorId",void 0),l([h({type:String})],R.prototype,"title",void 0),l([h({type:String})],R.prototype,"domain",void 0),l([h({type:String,attribute:"placement"})],R.prototype,"placement",void 0),l([h({type:Boolean,attribute:"should-track-position"})],R.prototype,"shouldTrackPosition",void 0),l([h({type:Boolean,attribute:"is-pdp-combined"})],R.prototype,"isPdpCombined",void 0),l([h({type:String,attribute:"encrypted-tracking-payload"})],R.prototype,"encryptedTrackingPayload",void 0),l([h({type:Array,attribute:"additional-event-metadata"})],R.prototype,"additionalEventMetadata",void 0),l([h({type:Boolean,attribute:"is-category-takeover"})],R.prototype,"isCategoryTakeover",void 0),l([h({type:Boolean,attribute:"pixel-firing-refactor-experiment-enabled"})],R.prototype,"isPixelFiringRefactorExperimentEnabled",void 0),l([h({type:String,attribute:"ads-correlation-id"})],R.prototype,"adsCorrelationId",void 0),l([d()],R.prototype,"isHiddenOnSort",void 0),l([d()],R.prototype,"isClickDisabled",void 0),R=l([c("shreddit-comments-page-ad")],R);
