import{M as e,O as t,a2 as a,_ as r,n,e as i}from"./shell-2264602c.js";import{x as s,K as o,R as c}from"./age-gate-standalone-client-js-5357b0cf.js";import{s as d}from"./icon-82dd10b4.js";const l=Math.ceil(20);let p=class extends d{constructor(){super(...arguments),this.siteKey="",this.loadedScriptsByKey=new Map,this.execute=async()=>{try{const e=this.getConfig();return!!e&&(await this.load(this.siteKey),await this.manageToken(e),!0)}catch(e){return e instanceof Error&&window.Sentry?.captureException(e),!1}}}connectedCallback(){super.connectedCallback(),window.addEventListener("afterRoute",this.execute),this.execute()}disconnectedCallback(){window.removeEventListener("afterRoute",this.execute),super.disconnectedCallback()}async load(e){this.loadedScriptsByKey.has(e)||this.loadedScriptsByKey.set(e,this.loadLazyScriptForKey(e)),await this.loadedScriptsByKey.get(e),this.executeIsReady()||await this.pollExecuteIsReady()}executeIsReady(){return"function"==typeof window.grecaptcha?.enterprise?.execute}loadLazyScriptForKey(e){return s(`script[data-src="${c}?render=${e}"]`)}pollExecuteIsReady(){return new Promise(((e,t)=>{let a=0;const r=setInterval((()=>{a>=l?(clearInterval(r),t()):this.executeIsReady()?(clearInterval(r),e()):a++}),50)}))}async manageToken({pageType:e,siteKey:t}){const a=await this.fetchToken(t,e),r=await this.sendToken(a);if(!0!==r?.data?.createCaptchaToken?.ok)throw new Error("Failed to transport reputation recaptcha token")}async getToken(e,t){const{siteKey:a}=t||this.getConfig()||{};if(!a)throw new Error("Missing required site-key attribute");return await this.load(a),this.fetchToken(a,e)}async fetchToken(e,t){let a=0;for(;a<3;)try{const a=await(window.grecaptcha?.enterprise?.execute?.(e,{action:t}));if("string"!=typeof a)throw new Error("Failed to generate valid reputation recaptcha token");return a}catch(e){if(!(e instanceof Error&&e.message.includes("Invalid site key or not loaded in api.js")))throw e;a++,await o(1e3)}throw new Error("Failed to generate valid reputation recaptcha token")}async sendToken(a){return e({operation:t.CreateCaptchaToken,variables:{input:{token:a}}})}getPageType(){return a()}getConfig(){const{siteKey:e}=this;if(!e)return null;const t=this.getPageType();return t?{pageType:t,siteKey:e}:null}};r([n({type:String,attribute:"site-key"})],p.prototype,"siteKey",void 0),p=r([i("reputation-recaptcha")],p);export{p as ReputationRecaptcha};
