import{hg as t,hh as e,dP as i,hi as s,_ as n,bn as a,u as r,E as o,hj as l,I as c,hk as d,c as u,hl as h,hm as f,hn as p,cE as m,bR as v,n as g,e as y}from"./shell-2264602c.js";import{s as b,a as E,x as _}from"./icon-82dd10b4.js";import{i as S,g as I,b as L,r as A,h as w,F as M,j as O,k as C,l as R}from"./filterNullish-60f7e90f.js";class V{get active(){return this.duration>0}get timeRemaining(){return`${Math.floor(this.duration/6e4)}:${Math.ceil(this.duration%6e4/1e3).toString().padStart(2,"0")}`}get secondsRemaining(){return Math.ceil(this.duration/1e3).toString()}constructor(t){this.duration=0,this.interval=0,this.update=()=>{this.duration=this.duration-this.interval,this.duration<=0&&this.reset(),this.host.requestUpdate()},this.host=t,this.host.addController(this)}hostDisconnected(){this.reset()}reset(){clearInterval(this.timeout),this.duration=0,this.interval=0}start(t,e=1e3){this.reset(),this.duration=t,this.interval=e,this.timeout=setInterval(this.update,this.interval),this.host.requestUpdate()}}function F(t){if(S(t)&&(t.checked=t.hasAttribute("checked")),I(t))t.formResetCallback&&t.formResetCallback();else if(t instanceof HTMLInputElement)t.value=t.getAttribute("value")||"";else if(t instanceof HTMLTextAreaElement)t.value=t.textContent||"";else if(L(t))for(const e of t.options)e.selected=e.hasAttribute("selected");else t instanceof HTMLOutputElement&&(t.value=t.defaultValue)}function T(e){const i={};for(const s of e){const[e,n]=s;if(n instanceof File)throw t(e);Object.prototype.hasOwnProperty.call(i,e)?Array.isArray(i[e])?i[e].push(n):i[e]=[i[e],n]:i[e]=n}return i}const k=(t,e=0)=>{if(6!==e)return t instanceof HTMLInputElement||t instanceof HTMLButtonElement?t:t?k(t.parentElement,e+1):void 0};function P(t){let i;document.activeElement&&document.activeElement!==document.body&&(i=e(document.activeElement)),!i&&t&&t.target instanceof Element&&(i=function(t){var e;for(const i of null!==(e=t.composedPath())&&void 0!==e?e:[])if((i instanceof HTMLInputElement||i instanceof HTMLButtonElement)&&"submit"===i.type)return i}(t));const s=i instanceof HTMLButtonElement||i instanceof HTMLInputElement;if(i&&t&&!s&&(i=k(i.parentElement)),i)return(i instanceof HTMLInputElement||i instanceof HTMLButtonElement)&&"submit"===i.type?i:void 0}function H(t){return t instanceof HTMLElement&&Object.prototype.hasOwnProperty.call(t.dataset,"faceplateConstraint")}function j(t,e,i){return u("faceplate-alert",{level:c.error,message:h("Form submission failed"),meta:null==t?void 0:t.toString(),sourceElement:e,cause:i})}const q={[i.UrlEncoded]:s,[i.JSON]:function(t){return JSON.stringify(T(t))},[i.FormData]:t=>t};let x=class extends b{constructor(){super(...arguments),this.accept="text/vnd.reddit.partial+html, application/json",this.enctype=i.UrlEncoded,this.action="",this.disabled=!1,this.method=a.Post,this.target="",this.partialMode=r.Append,this.novalidate=!1,this.validationTrigger="focusout",this._events=new o(this),this.formSubmissionInProgress=!1,this.rulesDidChange=!1,this.focusedInputForValiditySinceLastSubmit=!1,this._shouldRebuildElements=!0,this._elements={},this._validationObserverCount=0,this._asyncInputOperations=0,this.requester=l,this.encoders=q,this._handleInput=this._events.define("input",(()=>{this._shouldRebuildElements=!0})),this._handleFormSubmit=this._events.define("submit",(t=>{const e=t.target;if(!(e&&e instanceof HTMLFormElement))return;t.preventDefault();const i=P(t);this.submit(e.action,void 0,i)})),this._handleClick=this._events.define("click",(t=>{const e=P(t);e&&(t.preventDefault(),this.submit(this.action,void 0,e))})),this._handleFocusIn=this._events.define("focusin",(t=>{if(w(t.target)&&H(t.target))if(this.formSubmissionInProgress){const e=this;t.target.addEventListener("input",(function t(i){var s;e.validateElementAgainstRules(i.target)&&(null===(s=i.target)||void 0===s||s.removeEventListener("input",t))}))}else t.target.setCustomValidity("")})),this.configureValidation=()=>this.addEventListener(this.validationTrigger,(t=>{w(t.target)&&(H(t.target)&&this.validateElementAgainstRules(t.target),M in t.target.constructor&&t.target.syncInputValidity(),this.notifyObservers(t.target))})),this._handleFaceplateAlert=this._events.define("faceplate-alert",(t=>{const{level:e,name:i,message:s}=t.detail;e===c.error&&i&&s&&this.invalidateFieldWithMessage(i,s)&&(t.target.remove(),t.stopPropagation())})),this.register=t=>{this.dispatchEvent(new CustomEvent("_faceplate-register-input",{detail:{target:t}}))},this._handleRegister=this._events.define("_faceplate-register-input",(t=>{var e;t.stopImmediatePropagation(),t.detail.register&&(null===(e=t.detail)||void 0===e||e.register(this)),this._shouldRebuildElements=!0;const{target:i}=t.detail;i.syncInputValidity(!1),this.notifyObservers(i)}))}updated(t){t.has("validationTrigger")&&(t.get("validationTrigger")&&this.removeEventListener(t.get("validationTrigger"),this.configureValidation),this.configureValidation())}get canSubmit(){return!(this.disabled||this.formSubmissionInProgress||this._asyncInputOperations>0)}get elements(){if(this._shouldRebuildElements){this._elements={};for(const t of this.recognizedInputs()){const{name:e}=t;if(e)if(e in this._elements){const i=this._elements[e];let s;Array.isArray(i)?(s=i,i.push(t)):(s=[i,t],s.value=O(i)&&i.checked?i.value:"",this._elements[e]=s),O(t)&&t.checked&&(s.value=t.value)}else this._elements[t.name]=t}this._shouldRebuildElements=!1}return this._elements}static get styles(){return E`:host{display:block;margin-bottom:1rem}`}render(){return _` <slot></slot> `}addEventListener(t,e,i){super.addEventListener(t,e,i),"_faceplate-validation-change"===t&&(this._validationObserverCount+=1)}removeEventListener(t,e,i){super.removeEventListener(t,e,i),"_faceplate-validation-change"===t&&(this._validationObserverCount-=1)}async disableUntil(t){this._asyncInputOperations+=1;try{await t}finally{this._asyncInputOperations-=1}}notifyObservers(t){if(this._validationObserverCount){const e=d("_faceplate-validation-change",{bubbles:!0,cancelable:!1,composed:!1,detail:{input:t,message:t.validationMessage,name:t.name}});this.dispatchEvent(e)}}invalidateFieldWithMessage(t,e){const i=this.querySelector(`[name="${t}"]`);return!!w(i)&&(i.setCustomValidity(e),i.setAttribute("faceplate-dirty",""),this.notifyObservers(i),e&&i.addEventListener("input",(function t(){i.setCustomValidity(""),i.removeEventListener("input",t)})),e&&!this.focusedInputForValiditySinceLastSubmit&&(this.focusedInputForValiditySinceLastSubmit=!0,this.reportFieldValidity(i)),!0)}reportFieldValidity(t){const e=t.reportValidity();if(!e&&null===t.offsetParent){const e=u("faceplate-alert",{level:c.error,message:h("Validation error on hidden input"),meta:`"${t.name}": ${t.validationMessage}`,sourceElement:this.tagName,cause:"faceplate-form-input-validation-failure"});this.dispatchEvent(e)}return e}get targetElement(){return this.target&&document.querySelector(this.target)||this}get isValid(){let t=!0;const e=P(),i=!(this.novalidate||e&&e.hasAttribute("formnovalidate"));for(const e of this.recognizedInputs())if(w(e)){if(e.disabled)continue;if(e.matches(":disabled"))continue;if(i&&(this.validateElementAgainstRules(e),!e.checkValidity())){t=!1;break}}return t}async submit(t=this.action,e,i){var s,n,a,r;if(!this.canSubmit)return;this.formSubmissionInProgress=!0,this.focusedInputForValiditySinceLastSubmit=!1;try{const d=u("faceplate-submit");if(this.dispatchEvent(d),d.defaultPrevented)return;const h=this.buildRequest(e,i);if(!h)return;if("dialog"===h.method){const t=this.closest("faceplate-dialog");if(!t)throw new Error("Unable to find parent faceplate-dialog element to close with form submission");return t.close(h.body)}let p=this.enctype;if(i&&i.hasAttribute("formenctype")&&(p=i.getAttribute("formenctype")),"log"===h.method){const t=this.encoders[p];return console.log(t?t(h.body):h.body)}i&&i.hasAttribute("formaction")&&(t=i.getAttribute("formaction"));const m={enctype:p,encoders:this.encoders,credentials:this.credentials};try{for(var o,l=!0,c=f(this.requester(t,h,m));!(s=(o=await c.next()).done);){r=o.value,l=!1;try{const t=r;if("faceplate-error"===t.type){const e=j(t.detail,this.tagName,"faceplate-form-fetch-failure");this.dispatchEvent(e);break}if(this.dispatchEvent(t),"faceplate-response"===t.type){await this.handleResponse(t.detail.response);break}}finally{l=!0}}}catch(t){n={error:t}}finally{try{l||s||!(a=c.return)||await a.call(c)}finally{if(n)throw n.error}}}catch(t){const e=j(t,this.tagName,"faceplate-form-submission-uncaught-error");this.dispatchEvent(e)}finally{return void(this.formSubmissionInProgress=!1)}}validateElementAgainstRules(t){var e;if(!H(t))return!0;if(this.rulesDidChange){const t=u("faceplate-form-constraints-changed");this.dispatchEvent(t),this.rulesDidChange=!1}t.setCustomValidity("");const i=C.getRegisteredElements(this);if(!i)return!0;const s=null===(e=t.dataset.faceplateConstraint)||void 0===e?void 0:e.split(" ");if(!s||!s.length)return!0;for(const e of s){const s=i.get(e);if(!s){console.warn(`Skipping validation against unknown rule "${e}"`);continue}const n=t.value;if(null!==n&&!s.validate(n))return t.setCustomValidity(s.message),!1}return!0}*elementsIterator(){yield*this.recognizedInputs()}recognizedInputs(){let t=new Set;for(const e of[...this.querySelectorAll("*")].filter(w))t.add(e);const e=this.querySelectorAll("output");for(let i=0;i<e.length;i++)t.add(e[i]);const i=R.getRegisteredElements(this);return i&&(t=new Set([...t,...i])),t}reset(){for(const t of this.recognizedInputs())F(t)}buildRequest(t,e){const i=new FormData;!e&&arguments.length<3&&(e=P());const s=!(this.novalidate||e&&e.hasAttribute("formnovalidate"));for(const t of this.recognizedInputs())if(w(t)){if(t.disabled)continue;if(t.matches(":disabled"))continue;if(s&&(this.validateElementAgainstRules(t),!this.reportFieldValidity(t)))return null;if(S(t)&&!t.checked)continue;const{name:e,value:n}=t;if(null===n)continue;if(n instanceof FormData){for(const t of n)i.append(t[0],t[1]);continue}if(!e)continue;if(L(t)&&t.multiple)for(const s of t.options)s.selected&&i.append(e,s.value);else if(t instanceof HTMLInputElement&&"file"===t.type){const s=t.files;if(s)for(const t of s)i.append(e,t)}else i.append(e,n)}if(t)for(const e of t)i.append(e.name,e.value);let n=this.method;return e&&(e.name&&e.value&&i.append(e.name,e.value),e.hasAttribute("formmethod")&&(n=p(e.getAttribute("formmethod")))),{body:i,method:n.toLowerCase(),headers:{Accept:this.accept}}}async handleResponse(t){const e=m(t);if("text/vnd.reddit.partial+html"===e){const e=await t.text(),i=this.targetElement;v(e,i,this.partialMode)}else if("application/json"===e&&t.status>=400){const e=await t.json();if("object"==typeof(i=e)&&i&&Object.prototype.hasOwnProperty.call(i,"title")&&Object.prototype.hasOwnProperty.call(i,"message")){const i=u("faceplate-alert",{level:c.error,name:e.title,message:h("Form responded with error"),meta:e.message,sourceElement:this.tagName,cause:`faceplate-form-response-error-${t.status}`});this.dispatchEvent(i)}}else"text/html"===e&&t.redirected&&(window.location.href=t.url);var i}};n([g({type:String})],x.prototype,"accept",void 0),n([g({type:String})],x.prototype,"enctype",void 0),n([g({type:String})],x.prototype,"action",void 0),n([g({type:Boolean,reflect:!0})],x.prototype,"disabled",void 0),n([g({converter:p,reflect:!0})],x.prototype,"method",void 0),n([g({type:String})],x.prototype,"target",void 0),n([g({type:String,attribute:"partial-mode"})],x.prototype,"partialMode",void 0),n([g({type:String})],x.prototype,"novalidate",void 0),n([g({type:String})],x.prototype,"credentials",void 0),n([g({type:String,attribute:"validation-trigger"})],x.prototype,"validationTrigger",void 0),x=n([y("faceplate-form")],x),A(x);export{V as C,x as F,T as c};
