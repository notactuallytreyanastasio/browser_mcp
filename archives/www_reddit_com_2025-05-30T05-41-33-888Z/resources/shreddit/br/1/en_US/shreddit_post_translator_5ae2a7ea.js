import{a as t,az as s,P as e,ew as i,T as a,ex as n,t as r,_ as o,n as l,ay as d,g as h,l as c,L as p,aA as u,e as v,bN as m,dH as T,dK as b,bn as y,ap as P,dN as g,bQ as A,dI as f,dL as C,c as E,dM as S,ey as I,ez as M,eA as V}from"./shell-2264602c.js";import{B as x}from"./base-translator-57da136d.js";import{P as D,p as w}from"./links-9b598b77.js";import"./translation-feedback-modal-client-js-1348daab.js";import"./translation-intervention-modal-337135d6.js";import{A as k,x as B,bt as O,I as F,c as L,s as q}from"./icon-82dd10b4.js";import{j as N,k as $,l as j}from"./translations-8a80e526.js";import"./banned-user-banner-client-js-fbb59000.js";const R={get:()=>{if(!c.isAvailable())return;const t=c.getItem(p.I18nPostTranslationBanner);return t?JSON.parse(t):void 0},set:t=>{c.isAvailable()&&c.setItem(p.I18nPostTranslationBanner,JSON.stringify(t))},update:t=>{const s=R.get()||{};R.set({...s,...t})}};let _=class extends(t(q)){constructor(){super(...arguments),this.isImmersiveVisit=!1,this.isMtSeoVisit=!1,this.translationContextValue=s,this.pubsub=new e(this),this.onPostTranslationOverride=t=>{(t.isContextUpdateEvent||"PDP"===t.pageType&&"PDP_BANNER"!==t.source)&&(this.translationOverrideActive=t.isTranslationActive)},this.getIsTranslationActive=()=>"boolean"==typeof this.translationOverrideActive?this.translationOverrideActive:i()||!!this.translationContextValue?.isTranslationActive,this.toggleTranslation=()=>{this.userHasInteracted||(this.userDisplayCount=0,R.update({userDisplayCount:this.userDisplayCount}),this.userHasInteracted=!0);const t=!this.getIsTranslationActive(),s={pageType:"PDP",id:this.postId,isTranslationActive:t,source:"PDP_BANNER"};this.trackClickEvent(),this.pubsub.publish(a.I18nPostTranslationOverride,s),this.translationOverrideActive=t},this.handleClose=()=>{this.trackDismissEvent(),this.isDismissedByUser=!0,R.update({isDismissedByUser:this.isDismissedByUser})},this.isEligibleForBanner=()=>{const t=this.variant===n.ALL_AUTOMATIC_BANNER,s=this.variant===n.ALL_MANUAL_BANNER||this.variant===n.ALL_MANUAL_BANNER_INTERVENTION;return!(!t&&!s)&&((!s||!this.isDismissedByUser)&&!(t&&this.userDisplayCount&&this.userDisplayCount>3))}}trackViewEvent(){const t=this.getIsTranslationActive();this.trackEvent(N({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:t,isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}trackClickEvent(){this.trackEvent($({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:this.getIsTranslationActive(),isPostTranslatedAfterClick:!this.getIsTranslationActive(),isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}trackDismissEvent(){this.trackEvent(j({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:this.getIsTranslationActive(),isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}connectedCallback(){if(super.connectedCallback(),!this.isEligibleForBanner())return;this.trackViewEvent(),this.pubsub.subscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride,!1);const t=R.get();this.userDisplayCount=t?.userDisplayCount??0,this.isDismissedByUser=t?.isDismissedByUser??!1,this.variant===n.ALL_AUTOMATIC_BANNER&&(this.userDisplayCount+=1,R.update({userDisplayCount:this.userDisplayCount}))}disconnectedCallback(){super.disconnectedCallback(),this.pubsub.unsubscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride)}render(){if(!this.isEligibleForBanner())return k;const t=this.getIsTranslationActive();return B`<div role="banner" aria-labelledby="pdp-post-translation-banner-sr-label" data-testid="pdp-post-translation-banner-container" class="mx-md xs:mx-0 rounded-[12px] bg-neutral-background-container text-secondary-plain h-[40px] px-md flex items-center justify-between gap-sm mt-md -mb-xs"> <div class="flex items-center gap-sm"> ${O({size:F.Small,attributes:{"aria-hidden":"true"}})} <span id="pdp-post-translation-banner-sr-label" class="sr-only" aria-live="assertive"> ${t?"Post is translated, original language available":"Post is not translated, translations are available"} </span> <span class="text-12" aria-hidden="true"> ${t?"Translations active":"Translations available"} </span> <button class="bg-transparent border-none p-0 text-primary-plain text-12 cursor-pointer" @click="${this.toggleTranslation}" data-testid="toggle-translation-button"> ${t?"Show original":"Translate"} </button> </div> <button @click="${this.handleClose}" class="bg-transparent p-0 border-0 inline-flex items-center" data-testid="close-banner-button" aria-label="Close"> ${L({size:F.Small,attributes:{className:"cursor-pointer"}})} </button> </div>`}};_.styles=[r],o([l({type:String,attribute:"post-id"})],_.prototype,"postId",void 0),o([l({type:String,attribute:"variant"})],_.prototype,"variant",void 0),o([l({type:Boolean,attribute:"is-immersive-visit"})],_.prototype,"isImmersiveVisit",void 0),o([l({type:Boolean,attribute:"is-mt-seo-visit"})],_.prototype,"isMtSeoVisit",void 0),o([d({context:u,subscribe:!0}),h()],_.prototype,"translationContextValue",void 0),o([h()],_.prototype,"translationOverrideActive",void 0),o([h()],_.prototype,"userDisplayCount",void 0),o([h()],_.prototype,"userHasInteracted",void 0),o([h()],_.prototype,"isDismissedByUser",void 0),_=o([v("pdp-post-translation-banner")],_);const U="feed",z="pdp";let H=class extends x{constructor(){super(...arguments),this.avoidedSeoTranslation=!1,this.translatorType=z,this.isSeoVisit=!1,this.isImmersiveVisit=!1,this.isMtSeoVisit=!1,this.postId="",this.withInterventionModal=!1,this.postOverrides={},this.pubsub=new e(this),this.onPostTranslationOverride=t=>{t.isContextUpdateEvent||("PDP"===t.pageType&&this.translatorType===z?(this.postOverrides[t.id]=t.isTranslationActive,this.fetchAndRenderPost(t.isTranslationActive)):"FEED"===t.pageType&&this.translatorType===U&&(this.postOverrides[t.id]=t.isTranslationActive,this.fetchAndRenderFeedPost(t.id,t.isTranslationActive)))},this.onMoreCommentsPostMetrics=()=>{this.submitTranslationMetrics(m.LoadMore)},this.handleMorePostsPartialsLoaded=t=>{if("faceplate-load"!==t.type)return;if(!this.translationContextValue.isTranslationActive)return;if(!("src"in t.detail))return;const s=t.detail.src,e=s.startsWith("/svc/shreddit/feeds/"),i=s.includes("?after=")||s.includes("&after=");e&&i&&this.submitTranslationMetrics(m.Pagination)}}connectedCallback(){super.connectedCallback(),this.pubsub.subscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride,!1),this.addEventListener(T,this.handleTranslationFeedback),this.translatorType===U&&this.addEventListener("faceplate-load",this.handleMorePostsPartialsLoaded),this.translatorType===z&&this.pubsub.subscribe(a.I18nMoreCommentsPostMetrics,this.onMoreCommentsPostMetrics,!1)}disconnectedCallback(){this.pubsub.unsubscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride),this.removeEventListener(T,this.handleTranslationFeedback),this.translatorType===U&&this.removeEventListener("faceplate-load",this.handleMorePostsPartialsLoaded),this.translatorType===z&&this.pubsub.unsubscribe(a.I18nMoreCommentsPostMetrics,this.onMoreCommentsPostMetrics)}async onTranslationsEnabled(){if(this.translatorType===z){if(this.isSeoVisit&&!this.avoidedSeoTranslation)return this.avoidedSeoTranslation=!0,this.sendPostViewEventForPDP(),void this.submitTranslationMetrics();await this.fetchAndRenderPost(!0)}else await this.fetchAndRenderAllPosts(!0);this.submitTranslationMetrics()}async onTranslationsDisabled(){this.translatorType===z?(this.avoidedSeoTranslation=!0,await this.fetchAndRenderPost(!1)):await this.fetchAndRenderAllPosts(!1),this.submitTranslationMetrics()}getShredditPost(){return this.querySelector("shreddit-post")}getAllShredditPosts(){return this.querySelectorAll("shreddit-post")}async fetchAndRenderPost(t){let s;const e=this.getPostToFetch(t);if(e&&(s=await this.fetchPost(e,t)),s){this.saveElementsToCache(s,t);const e=this.getShredditPost(),i=e?[e]:[];this.saveDOMPostsToCache(i,t)}this.renderCacheForShredditPosts(t),this.sendPostViewEventForPDP()}async fetchAndRenderFeedPost(t,s){const e=this.querySelector(`shreddit-post#${t}`);if(!e)return;const i=[e];if(this.isPostTranslationMissing(e,s)){const e=await this.fetchAllPosts(i,s);e&&e.length>0?this.saveElementsToCache(e,s):this.saveEmptyPostsToCache([t])}this.saveDOMPostsToCache(i,s),this.renderCacheForShredditPosts(s,[t])}async fetchAndRenderAllPosts(t){let s;const e=this.getAllPostsToFetch(t);if(e&&(s=await this.fetchAllPosts(e,t)),s){this.saveElementsToCache(s,t);const e=this.getAllShredditPosts();this.saveDOMPostsToCache(e,t)}this.renderCacheForShredditPosts(!!this.translationContextValue.isTranslationActive)}async fetchPost(t,s){if(!t)return null;const e=s?b.GetTranslation:b.GetOriginal,i=new FormData;i.append("postId",t.id),i.append("translationState",e),t.isTranslatable&&i.append("isTranslatable","true");const a=await this.fetchRequestPartial("/svc/shreddit/translated-post/",{method:y.Post,body:i});return a||this.saveEmptyPostsToCache([t.id]),a}async fetchAllPosts(t,s){const e=t?.map((t=>t.id));if(!e||0===e.length)return null;const i=new FormData;e.forEach((t=>{i.append("postIds[]",t)})),i.append("includeTranslation",s?"true":"false"),i.append("isNewFormat","true");const a=(t&&t[0])?.viewContext||D.PopularFeed,n=(t&&t[0])?.viewType||P.CardView;if(i.append("feedViewType",n),i.append("postViewContext",a),s){let s=Array.from(t);s=s.filter((t=>t.isTranslatable)),s.forEach((t=>{i.append("isTranslatableIds[]",t.id)}))}const r=await this.fetchRequestPartial("/svc/shreddit/translated-posts/",{method:y.Post,body:i});return r||this.saveEmptyPostsToCache(e),r}getPostToFetch(t){const s=this.getShredditPost();return s?this.isPostTranslationMissing(s,t)?s:null:(this.logError({error:"post not found"}),null)}getAllPostsToFetch(t){const s=this.getAllShredditPosts();if(0===s.length)return this.logError({error:"all posts not found"}),null;const e=[];return s?.forEach((s=>{this.isPostTranslationMissing(s,t)&&e.push(s)})),e}isPostTranslationMissing(t,s){if(t.isTranslatable){const e=this.objectTranslationCache.get(t.id);if(s&&!t.isPostTranslated&&!e?.translatedElement||!s&&t.isPostTranslated&&!e?.originalElement)return!0}return!1}sendPostViewEventForPDP(){const t=this.getShredditPost();t&&this.trackEvent(this,w(t,t.isPostTranslated))}saveEmptyPostsToCache(t){t.forEach((t=>{this.objectTranslationCache.set(t,{translatedElement:{},originalElement:{}})}))}saveDOMPostsToCache(t,s){t?.forEach((t=>{const e=this.objectTranslationCache.get(t.id)||{},i=s&&e.originalElement||!s&&e.translatedElement,a=s&&t.isPostTranslated||!s&&!t.isPostTranslated;if(i||a)return;const n=t.querySelector('[slot="title"]')?.textContent,r=t.querySelector('[slot="text-body"]')?.innerHTML,o=t.querySelector(`.${g}`)?.src,l=t.querySelector("zoomable-img")?.querySelector(A.IMG)?.src,d=t.querySelector(`.${g}`)?.srcset,h={};n&&(h.title=n),r&&(h.body=r),o&&(h.img=o),l&&(h.imgfullsize=l),d&&(h.imgsrcset=d),s?e.originalElement=h:e.translatedElement=h,this.objectTranslationCache.set(t.id,e)}))}renderCacheForShredditPosts(t,s){const e=(s,e)=>{const i=this.querySelector(`shreddit-post#${e}`),a=t?s.translatedElement:s.originalElement;if(!i||!a)return;const n=i.querySelector('[slot="title"]'),r=a.title;n&&r&&(n.textContent=r);const o=i.querySelector('[slot="text-body"]'),l=o?.querySelector(`#${V(e)}`),d=a.body;l&&d&&(l.innerHTML=d);const h=i.querySelector(`.${g}`),c=i.querySelector("zoomable-img")?.querySelector(A.IMG),p=a.img,u=a.imgfullsize,v=a.imgsrcset;p&&h?.setAttribute("src",p),v&&h?.setAttribute("srcset",v),u&&c?.setAttribute("src",u),i.isPostTranslated=t};s?.length?s.forEach((t=>{const s=this.objectTranslationCache.get(t);s&&e(s,t)})):this.objectTranslationCache.forEach(e)}handleTranslationFeedback(t){const s=this.translationContextValue.isTranslationActive,e=this.translatorType===z?this.getShredditPost():this.querySelector(`shreddit-post#${t.detail.postId}`),i=this.translatorType===z?e?.id:t.detail.postId,a=e?.querySelector('[slot="title"]'),n=e?.querySelector('[slot="text-body"]'),r=this.shadowRoot?.getElementById(f.ID.FEEDBACK_MODAL);r&&r.show?.({post:{id:i||"",title:a?.textContent?.trim(),body_text:n?.textContent?.trim(),translation_state:s}})}submitTranslationMetrics(t){this.reportMetrics&&(this.translatorType===z&&this.submitTranslationMetricsPdp(t),this.translatorType===U&&this.submitTranslationMetricsFeeds(t))}buildPostMetrics(t){if(!t)return null;const s=this.translationContextValue?.isTranslationActive||!1,e=t?this.objectTranslationCache.get(t?.id):null,i=t.querySelector('[slot="title"')?.textContent||"",a=t.querySelector('[slot="text-body"')?.textContent||"";let n=s?"":i,r=s?i:"",o=s?"":a,l=s?a:"";return e&&(n=e.originalElement?.title||n,r=e.translatedElement?.title||r,o=e.originalElement?.body||o,l=e.translatedElement?.body||l),C({postId:t.id,postType:t.postType||"",translationSetting:s,originalTitle:n,translatedTitle:r,originalBody:o,translatedBody:l,isTitleTranslated:t.isPostTranslated,isBodyTranslated:a?t.isPostBodyTranslated:t.isPostTranslated,isTranslatable:t.isTranslatable})}submitTranslationMetricsPdp(t){if(!this.reportMetrics)return;if(this.translatorType!==z)return;const s=this.querySelector("shreddit-post");if(!s)return;const e={},i=this.buildPostMetrics(s);e.scenario=t||this.metricsScenario,e.targetLanguage=s.translationLanguage||"",e.post=i||{},this.dispatchEvent(E(S,e))}submitTranslationMetricsFeeds(t){if(!this.reportMetrics)return;if(this.translatorType!==U)return;const s=this.querySelectorAll("shreddit-post");if(!s||0===s.length)return;const e={},i=[];let a="";s.forEach((t=>{i.push(this.buildPostMetrics(t)),a=t.translationLanguage??a})),e.scenario=t||this.metricsScenario,e.targetLanguage=a,e.posts=I(i),this.dispatchEvent(E(M,e))}render(){return B` <pdp-post-translation-banner post-id="${this.postId}" variant="${this.indicatorsVariant}" ?is-immersive-visit="${this.isImmersiveVisit}" ?is-mt-seo-visit="${this.isMtSeoVisit}"></pdp-post-translation-banner> <div><slot></slot></div> ${this.withInterventionModal?B`<translation-intervention-modal mode="post" page-type="${this.translatorType}" ?is-immersive-visit="${this.isImmersiveVisit}"></translation-intervention-modal>`:k} <translation-feedback-modal id="${f.ID.FEEDBACK_MODAL}"> </translation-feedback-modal> `}};o([l({type:String,attribute:"translator-type"})],H.prototype,"translatorType",void 0),o([l({type:Boolean,attribute:"is-seo-visit"})],H.prototype,"isSeoVisit",void 0),o([l({type:Boolean,attribute:"is-immersive-visit"})],H.prototype,"isImmersiveVisit",void 0),o([l({type:Boolean,attribute:"is-mt-seo-visit"})],H.prototype,"isMtSeoVisit",void 0),o([l({type:String,attribute:"post-id"})],H.prototype,"postId",void 0),o([l({type:Boolean,attribute:"with-intervention-modal"})],H.prototype,"withInterventionModal",void 0),o([l({type:String,attribute:"indicators-variant"})],H.prototype,"indicatorsVariant",void 0),o([h()],H.prototype,"postOverrides",void 0),H=o([v("shreddit-post-translator")],H);
