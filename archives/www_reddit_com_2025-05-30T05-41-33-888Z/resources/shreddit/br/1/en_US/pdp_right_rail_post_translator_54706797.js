import{aQ as t,bn as s,bp as e,t as n,_ as a,n as i,g as r,e as o}from"./shell-2264602c.js";import{B as l}from"./base-translator-57da136d.js";import{x as h}from"./icon-82dd10b4.js";const c=".i18n-list-item-post-title",d="reddit-pdp-right-rail-post",g=".i18n-list-item-post-content",p="post-id",u="data-post-id",T="#feed-translation-title";let f=class extends l{constructor(){super(...arguments),this.isHeaderTranslation=!1,this.isFetchingTranslations=!1,this._partialRequestController=new t(this)}async onTranslationsEnabled(){if(this.isHeaderTranslation)return void await this.fetchAndRenderPosts(!0);if(this.translatedStringsCache)return void this.renderStrings(this.translatedStringsCache);if(this.isFetchingTranslations)return;const t=this.getTranslatableContent();if(!t)return;this.originalStringsCache=t;const s=await this.fetchTranslations(t);s&&(this.translatedStringsCache=s,this.translationContextValue.isTranslationActive&&this.renderStrings(s))}async onTranslationsDisabled(){this.isHeaderTranslation?await this.fetchAndRenderPosts(!1):this.originalStringsCache&&this.renderStrings(this.originalStringsCache)}getTranslatableContent(){const t={},s=this.querySelectorAll(d)||[];return Array.from(s).map((s=>{const e=s.querySelector(g),n=e?.getAttribute(p),a=e?.querySelector(c)?.innerHTML;n&&a&&(t[n]=a)})),t}async fetchTranslations(t){const n={},a=Object.keys(t);if(0===a.length)return{};const i=new FormData;i.append("includeTranslation",String(!!this.translationContextValue.isTranslationActive)),a.forEach((t=>{i.append("postIds[]",t)}));this.isFetchingTranslations=!0;const r=await this._partialRequestController.request("/svc/shreddit/translated-posts",{method:s.Post,body:i});this.isFetchingTranslations=!1;const o=await(r?.text());if(!o)return{};const l=e(o);return 0===l.length?{}:(l.map((t=>{const s=t.getAttribute(u),e=t.querySelector(`${T}-${s}`)?.innerHTML;s&&e&&(n[s]=e)})),n)}renderStrings(t){const s=this.querySelectorAll(d)||[];Array.from(s).map((s=>{const n=s.querySelector(g),a=n?.getAttribute(p),i=n?.querySelector(c);if(a&&i&&t[a]){const s=e(`<span>${t[a]}</span>`);i.replaceChildren(s[0])}}))}async fetchAndRenderPosts(t){let s;const e=this.getPostsToFetch(t);if(e&&(s=await this.fetchPosts(e,t)),s){this.saveElementsToCache(s,t);const e=this.getAllRightRailPosts();this.saveDOMPostsToCache(e,t)}this.renderCacheForPosts(t)}getPostsToFetch(t){const s=[];return this.getAllRightRailPosts().forEach((e=>{const n=e.rightRailPostId;n&&this.isPostTranslationMissing(e,t)&&s.push(n)})),s}isPostTranslationMissing(t,s){const e=this.objectTranslationCache.get(t.rightRailPostId);return!((!s||t.isTranslated||e?.translatedElement)&&(s||!t.isTranslated||e?.originalElement))}async fetchPosts(t,e){if(!t||0===t.length)return null;const n=new FormData;t.forEach((t=>{n.append("postIds[]",t)})),n.append("includeTranslation",e?"true":"false"),n.append("isNewFormat","true");const a=await this.fetchRequestPartial("/svc/shreddit/translated-posts/",{method:s.Post,body:n});return a||this.saveEmptyPostsToCache(t),a}saveEmptyPostsToCache(t){t.forEach((t=>{this.objectTranslationCache.set(t,{translatedElement:{},originalElement:{}})}))}saveDOMPostsToCache(t,s){t?.forEach((t=>{const e=this.objectTranslationCache.get(t.rightRailPostId)||{},n=s&&e.originalElement||!s&&e.translatedElement,a=s&&t.isTranslated||!s&&!t.isTranslated;if(n||a)return;const i=t?.querySelector(g),r=i?.querySelector(c)?.getAttribute("title"),o={};r&&(o.title=r),s?e.originalElement=o:e.translatedElement=o,this.objectTranslationCache.set(t.rightRailPostId,e)}))}renderCacheForPosts(t){this.objectTranslationCache.forEach(((s,n)=>{const a=this.querySelector(`${d}[right-rail-post-id="${n}"]`),i=a?.querySelector(g),r=t?s.translatedElement:s.originalElement;if(!i||!r)return;const o=i?.querySelector(c),l=r.title;if(o&&l){const t=e(`<span>${l}</span>`);o.replaceChildren(t[0])}a.isTranslated=t}))}getAllRightRailPosts(){return this.querySelectorAll(d)}render(){return h`<div><slot></slot></div>`}};f.styles=[n],a([i({type:Boolean,attribute:"is-header-translation"})],f.prototype,"isHeaderTranslation",void 0),a([r()],f.prototype,"translatedStringsCache",void 0),a([r()],f.prototype,"originalStringsCache",void 0),a([r()],f.prototype,"isFetchingTranslations",void 0),f=a([o("pdp-right-rail-post-translator")],f);export{f as PdpRightRailPostTranslator};
